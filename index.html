<!DOCTYPE html>
<html lang="ka">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>áƒ‘áƒáƒœáƒ£áƒ¡ áƒ—áƒáƒ•áƒ¡áƒáƒ¢áƒ”áƒ®áƒ˜ â€” áƒ¢áƒ”áƒ¡áƒ¢áƒ˜</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=VT323&display=swap" rel="stylesheet">
  <style>
    /* ===== CIPHER FONT ===== */
    @font-face {
      font-family: 'CipherFont';
      src: url('Font%20Vers1.ttf') format('truetype'),
           url('https://kandelucky.github.io/widget_test/Font%20Vers1.ttf') format('truetype');
      font-display: swap;
    }

    :root {
      --primary: #6c5ce7;
      --primary-light: #a29bfe;
      --accent: #fd79a8;
      --success: #00b894;
      --warning: #fdcb6e;
      --bg-dark: #2d3436;
      --bg-light: #dfe6e9;
      --text: #2d3436;
      --radius: 16px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Fredoka', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100dvh;
      color: var(--text);
      overflow: hidden;
    }

    /* ===== ORIENTATION WARNING ===== */
    .orientation-warning {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: linear-gradient(135deg, #2d3436, #636e72);
      color: white;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 32px;
    }

    .orientation-warning .phone-icon {
      font-size: 64px;
      animation: rotate-phone 1.5s ease-in-out infinite;
      margin-bottom: 24px;
    }

    @keyframes rotate-phone {
      0%, 100% { transform: rotate(0deg); }
      50% { transform: rotate(90deg); }
    }

    .orientation-warning h2 { font-size: 22px; margin-bottom: 8px; }
    .orientation-warning p { font-size: 14px; opacity: 0.7; }

    @media (max-width: 768px) and (orientation: portrait) {
      .orientation-warning { display: flex !important; }
      .app-container { display: none !important; }
    }

    /* ===== APP CONTAINER ===== */
    .app-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 1.5vh 20px;
      height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    /* ===== HEADER ===== */
    .header {
      text-align: center;
      padding: clamp(4px, 2vh, 32px) 16px;
      color: white;
      flex-shrink: 0;
    }

    .header h1 {
      font-size: clamp(18px, 4vh, 42px);
      font-weight: 700;
      text-shadow: 0 3px 12px rgba(0,0,0,0.2);
      margin-bottom: 4px;
    }

    .header p {
      font-size: clamp(11px, 2vh, 18px);
      opacity: 0.85;
    }

    /* ===== CARD ===== */
    .card {
      background: white;
      border-radius: var(--radius);
      padding: clamp(10px, 2vh, 32px) clamp(12px, 2vw, 32px);
      margin-bottom: clamp(4px, 1vh, 20px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .card-title {
      font-size: clamp(14px, 2.5vh, 22px);
      font-weight: 700;
      margin-bottom: clamp(4px, 1vh, 16px);
      color: var(--primary);
      flex-shrink: 0;
    }

    /* ===== PASSWORD SECTION ===== */
    .password-section {
      text-align: center;
      justify-content: center;
    }

    .password-input-group {
      display: flex;
      gap: 12px;
      max-width: 400px;
      margin: clamp(8px, 2vh, 20px) auto;
    }

    .password-input-group input {
      flex: 1;
      padding: clamp(10px, 2vh, 14px) 18px;
      border: 3px solid var(--bg-light);
      border-radius: 12px;
      font-size: clamp(14px, 2.5vh, 18px);
      font-family: 'VT323', monospace;
      letter-spacing: 3px;
      outline: none;
      transition: border-color 0.3s;
    }

    .password-input-group input:focus {
      border-color: var(--primary);
    }

    .password-error {
      color: var(--accent);
      font-size: 14px;
      margin-top: 8px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .password-error.show { opacity: 1; }

    /* ===== ANIMATED BUTTON ===== */
    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 12px;
      font-family: 'Fredoka', sans-serif;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at var(--x, 50%) var(--y, 50%), rgba(255,255,255,0.4) 0%, transparent 60%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .btn:hover::after { opacity: 1; }
    .btn:active { transform: scale(0.95); }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: white;
      box-shadow: 0 4px 16px rgba(108, 92, 231, 0.4);
    }

    .btn-primary:hover {
      box-shadow: 0 6px 24px rgba(108, 92, 231, 0.6);
      transform: translateY(-2px);
    }

    .btn-primary:active { transform: translateY(0) scale(0.95); }

    .btn-success {
      background: linear-gradient(135deg, var(--success), #55efc4);
      color: white;
      box-shadow: 0 4px 16px rgba(0, 184, 148, 0.4);
    }

    .btn-download {
      background: linear-gradient(135deg, #0984e3, #74b9ff);
      color: white;
      box-shadow: 0 4px 16px rgba(9, 132, 227, 0.4);
      font-size: 18px;
      padding: 16px 32px;
    }

    /* ===== CIPHER PUZZLE ===== */
    .puzzle-section {
      display: none;
      animation: slideUp 0.6s ease-out;
      flex: 1;
      min-height: 0;
    }

    .puzzle-section.visible {
      display: flex;
      flex-direction: column;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .cipher-hint {
      background: var(--bg-light);
      border-radius: 8px;
      padding: clamp(6px, 1vh, 16px) 12px;
      margin-bottom: clamp(4px, 1vh, 20px);
      font-size: clamp(10px, 1.8vh, 14px);
      line-height: 1.4;
      flex-shrink: 0;
    }

    .cipher-hint strong { color: var(--primary); }

    .cipher-grid {
      display: flex;
      flex-wrap: wrap;
      gap: clamp(4px, 0.8vh, 12px);
      justify-content: center;
      align-content: center;
      flex: 1;
      min-height: 0;
    }

    .cipher-space { width: clamp(10px, 2vw, 20px); }

    .cipher-cell {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: clamp(2px, 0.5vh, 6px);
    }

    /* Cipher symbol box â€” uses custom font */
    .cipher-code {
      width: clamp(36px, min(10vw, 14vh), 64px);
      height: clamp(36px, min(10vw, 14vh), 64px);
      background: #fffdf5;
      color: var(--bg-dark);
      font-family: 'CipherFont', sans-serif;
      font-size: clamp(24px, min(7vw, 10vh), 44px);
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: clamp(6px, 1vh, 12px);
      border: 2px solid #e0dcd0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      user-select: none;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .cipher-code:hover {
      transform: scale(1.08);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .cipher-input {
      width: clamp(36px, min(10vw, 14vh), 64px);
      height: clamp(28px, min(7vw, 10vh), 46px);
      text-align: center;
      border: 2px solid var(--bg-light);
      border-radius: 6px;
      font-family: 'Fredoka', sans-serif;
      font-size: clamp(16px, min(4vw, 6vh), 24px);
      font-weight: 700;
      text-transform: uppercase;
      outline: none;
      transition: all 0.3s;
      color: var(--text);
    }

    .cipher-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
    }

    .cipher-input.correct {
      border-color: var(--success);
      background: #e6fff7;
      color: var(--success);
      animation: pop 0.3s ease-out;
    }

    .cipher-input.wrong {
      border-color: var(--accent);
      animation: shake 0.4s ease-out;
    }

    .cipher-input.hint {
      background: #f0e6ff;
      border-color: var(--primary-light);
      color: var(--primary);
    }

    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      75% { transform: translateX(6px); }
    }

    /* Cipher key â€” shows symbol = letter */
    .cipher-key {
      display: flex;
      flex-wrap: wrap;
      gap: clamp(3px, 0.5vh, 8px);
      justify-content: center;
      margin: clamp(4px, 0.8vh, 12px) 0;
      padding: clamp(6px, 1vh, 16px) 8px;
      background: #f8f9fa;
      border-radius: 8px;
      flex-shrink: 0;
    }

    .cipher-key-title {
      width: 100%;
      text-align: center;
      font-size: clamp(9px, 1.5vh, 13px);
      color: #636e72;
      margin-bottom: 2px;
    }

    .key-item {
      display: flex;
      align-items: center;
      gap: 3px;
      padding: clamp(2px, 0.5vh, 6px) clamp(6px, 1vw, 12px);
      background: #fffdf5;
      border: 2px solid #e0dcd0;
      border-radius: 6px;
      font-size: clamp(10px, 1.8vh, 14px);
      font-weight: 600;
    }

    .key-symbol {
      font-family: 'CipherFont', sans-serif;
      font-size: clamp(14px, 3vh, 24px);
      color: var(--bg-dark);
    }

    .key-letter {
      font-family: 'Fredoka', sans-serif;
      color: var(--primary);
    }

    .key-item.unknown {
      background: #eee;
      border-color: #ddd;
    }

    .key-item.unknown .key-letter {
      color: #999;
    }

    /* ===== PDF SECTION ===== */
    .pdf-section {
      display: none;
      text-align: center;
      animation: slideUp 0.6s ease-out;
    }

    .pdf-section.visible { display: block; }
    .pdf-icon { font-size: 48px; margin-bottom: 12px; }

    /* ===== VICTORY OVERLAY ===== */
    .victory-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease-out;
    }

    .victory-overlay.show { display: flex; }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .victory-card {
      background: white;
      border-radius: 24px;
      padding: clamp(28px, 6vw, 48px);
      text-align: center;
      max-width: 400px;
      width: 90%;
      animation: bounceIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      z-index: 1001;
    }

    @keyframes bounceIn {
      0% { opacity: 0; transform: scale(0.5); }
      100% { opacity: 1; transform: scale(1); }
    }

    .victory-card .trophy { font-size: clamp(36px, 10vh, 72px); margin-bottom: clamp(4px, 1vh, 16px); }
    .victory-card h2 { font-size: clamp(18px, 4vh, 28px); color: var(--primary); margin-bottom: 4px; }
    .victory-card p { color: #636e72; margin-bottom: clamp(8px, 2vh, 24px); font-size: clamp(12px, 2vh, 16px); }

    /* decoded message in victory */
    .decoded-message {
      font-size: clamp(20px, 5vh, 32px);
      font-weight: 700;
      color: var(--accent);
      margin: clamp(4px, 1vh, 12px) 0 clamp(8px, 2vh, 20px);
      letter-spacing: 2px;
    }

    /* ===== CONFETTI CANVAS ===== */
    #confetti-canvas {
      position: fixed;
      inset: 0;
      z-index: 1002;
      pointer-events: none;
    }

    /* ===== FOOTER ===== */
    .footer {
      text-align: center;
      padding: clamp(4px, 1vh, 24px);
      color: rgba(255,255,255,0.5);
      font-size: clamp(8px, 1.5vh, 12px);
      flex-shrink: 0;
    }

    /* ===== RESPONSIVE ===== */

    /* Mobile landscape â€” very tight vertical space */
    @media (max-height: 420px) {
      .header { padding: 2px 16px; }
      .header p { display: none; }
      .cipher-hint { display: none; }
      .top-controls { top: 8px; right: 8px; }
      .top-btn { width: 32px; height: 32px; font-size: 16px; }
    }

    /* Small screens */
    @media (max-width: 600px) {
      .password-input-group { flex-direction: column; }
      .password-input-group .btn { width: 100%; }
    }

    /* Desktop */
    @media (min-width: 769px) and (min-height: 600px) {
      .app-container { padding: 20px 32px; }
    }

    /* PDF section in viewport */
    .pdf-section.visible {
      display: flex;
      flex-direction: column;
    }

    .pdf-section .card {
      justify-content: center;
      align-items: center;
    }

    /* ===== SOUND TOGGLE ===== */
    .top-controls {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 100;
      display: flex;
      gap: 8px;
    }

    .top-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 20px;
      cursor: pointer;
      backdrop-filter: blur(8px);
      transition: background 0.3s;
    }

    .top-btn:hover { background: rgba(255,255,255,0.35); }

    /* ===== STATUS BAR ===== */
    .status-bar {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin: clamp(4px, 0.8vh, 16px) 0;
      font-size: clamp(10px, 1.8vh, 14px);
      color: #636e72;
      flex-shrink: 0;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
  </style>
</head>
<body>

  <!-- Orientation Warning -->
  <div class="orientation-warning">
    <div class="phone-icon">ğŸ“±</div>
    <h2>áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒáƒ›áƒáƒáƒ¢áƒ áƒ˜áƒáƒšáƒáƒ— áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜</h2>
    <p>áƒ—áƒáƒ•áƒ¡áƒáƒ¢áƒ”áƒ®áƒ˜ áƒ£áƒ™áƒ”áƒ— áƒ›áƒ£áƒ¨áƒáƒáƒ‘áƒ¡ áƒ°áƒáƒ áƒ˜áƒ–áƒáƒœáƒ¢áƒáƒšáƒ£áƒ  áƒ áƒ”áƒŸáƒ˜áƒ›áƒ¨áƒ˜</p>
  </div>

  <!-- Top Controls -->
  <div class="top-controls">
    <button class="top-btn" id="fullscreenToggle" title="áƒ¡áƒ áƒ£áƒš áƒ”áƒ™áƒ áƒáƒœáƒ–áƒ”">â›¶</button>
    <button class="top-btn" id="soundToggle" title="áƒ®áƒ›áƒ áƒ©áƒáƒ áƒ—áƒ•áƒ/áƒ’áƒáƒ›áƒáƒ áƒ—áƒ•áƒ">ğŸ”Š</button>
  </div>

  <!-- Confetti Canvas -->
  <canvas id="confetti-canvas"></canvas>

  <!-- Victory Overlay -->
  <div class="victory-overlay" id="victoryOverlay">
    <div class="victory-card">
      <div class="trophy">ğŸ†</div>
      <h2>áƒ’áƒ˜áƒšáƒáƒªáƒáƒ•!</h2>
      <div class="decoded-message" id="decodedMessage"></div>
      <p>áƒ¨áƒ”áƒœ áƒ’áƒáƒ¨áƒ˜áƒ¤áƒ áƒ” áƒ¡áƒáƒ˜áƒ“áƒ£áƒ›áƒšáƒ áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ!</p>
      <button class="btn btn-success" onclick="closeVictory()">áƒ’áƒáƒ’áƒ áƒ«áƒ”áƒšáƒ”áƒ‘áƒ</button>
    </div>
  </div>

  <!-- App -->
  <div class="app-container">
    <div class="header">
      <h1>ğŸ§© áƒ‘áƒáƒœáƒ£áƒ¡ áƒ—áƒáƒ•áƒ¡áƒáƒ¢áƒ”áƒ®áƒ˜</h1>
      <p>áƒáƒ áƒ áƒ•áƒ”áƒ áƒ¡áƒ˜áƒ˜áƒ¡ áƒ›áƒ¤áƒšáƒáƒ‘áƒ”áƒšáƒ”áƒ‘áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡</p>
    </div>

    <!-- Password Section -->
    <div class="card password-section" id="passwordSection">
      <div class="card-title">ğŸ” áƒ¨áƒ”áƒ˜áƒ§áƒ•áƒáƒœáƒ” áƒáƒáƒ áƒáƒšáƒ˜</div>
      <p>áƒ—áƒ£ áƒ¨áƒ”áƒ˜áƒ«áƒ˜áƒœáƒ” áƒáƒ áƒ áƒ•áƒ”áƒ áƒ¡áƒ˜áƒ, áƒáƒáƒ áƒáƒšáƒ˜ áƒ›áƒ˜áƒ˜áƒ¦áƒ” áƒ”áƒšáƒ¤áƒáƒ¡áƒ¢áƒáƒ–áƒ”</p>
      <div class="password-input-group">
        <input type="text" id="passwordInput" placeholder="â€¢ â€¢ â€¢ â€¢ â€¢ â€¢"
               autocomplete="off" spellcheck="false">
        <button class="btn btn-primary" id="unlockBtn" onclick="tryUnlock()">
          áƒ’áƒáƒ®áƒ¡áƒœáƒ
        </button>
      </div>
      <div class="password-error" id="passwordError">áƒáƒ áƒáƒ¡áƒ¬áƒáƒ áƒ˜ áƒáƒáƒ áƒáƒšáƒ˜. áƒ¡áƒªáƒáƒ“áƒ” áƒ—áƒáƒ•áƒ˜áƒ“áƒáƒœ!</div>
    </div>

    <!-- Puzzle Section (hidden until password) -->
    <div class="puzzle-section" id="puzzleSection">
      <div class="card">
        <div class="card-title">ğŸ” áƒ’áƒáƒ¨áƒ˜áƒ¤áƒ áƒ” áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ</div>

        <div class="cipher-hint">
          áƒ§áƒáƒ•áƒ”áƒšáƒ˜ <strong>áƒ¡áƒ˜áƒ›áƒ‘áƒáƒšáƒ</strong> áƒ¨áƒ”áƒ”áƒ¡áƒáƒ‘áƒáƒ›áƒ”áƒ‘áƒ áƒ”áƒ áƒ— <strong>áƒáƒ¡áƒáƒ¡</strong>.
          áƒ–áƒáƒ’áƒ˜áƒ”áƒ áƒ—áƒ˜ áƒáƒ¡áƒ áƒ£áƒ™áƒ•áƒ” áƒáƒ›áƒáƒ®áƒ¡áƒœáƒ˜áƒšáƒ˜áƒ áƒ›áƒ˜áƒœáƒ˜áƒ¨áƒœáƒ”áƒ‘áƒ”áƒ‘áƒ¨áƒ˜.
          áƒ›áƒáƒ«áƒ”áƒ‘áƒœáƒ” áƒ¨áƒ”áƒ¡áƒáƒ‘áƒáƒ›áƒ˜áƒ¡áƒáƒ‘áƒ áƒ“áƒ áƒ’áƒáƒáƒ áƒ™áƒ•áƒ˜áƒ” áƒ“áƒáƒœáƒáƒ áƒ©áƒ”áƒœáƒ˜!
        </div>

        <div class="status-bar">
          <div class="status-item">âœ… <span id="solvedCount">0</span> / <span id="totalCount">0</span></div>
          <div class="status-item">ğŸ’¡ áƒ›áƒ˜áƒœáƒ˜áƒ¨áƒœáƒ”áƒ‘áƒ”áƒ‘áƒ˜: <span id="hintCount">0</span></div>
        </div>

        <!-- Cipher Key -->
        <div class="cipher-key" id="cipherKey">
          <div class="cipher-key-title">áƒ¨áƒ˜áƒ¤áƒ áƒ˜áƒ¡ áƒ’áƒáƒ¡áƒáƒ¦áƒ”áƒ‘áƒ˜</div>
        </div>

        <!-- Puzzle Grid -->
        <div class="cipher-grid" id="cipherGrid"></div>
      </div>
    </div>

    <!-- PDF Section (hidden until puzzle solved) -->
    <div class="pdf-section" id="pdfSection">
      <div class="card" style="text-align:center">
        <div class="pdf-icon">ğŸ“„</div>
        <div class="card-title">áƒ‘áƒáƒœáƒ£áƒ¡ áƒ›áƒáƒ¡áƒáƒšáƒ áƒ›áƒ–áƒáƒ“áƒáƒ!</div>
        <p style="margin-bottom:20px; color:#636e72;">
          áƒ’áƒáƒ“áƒ›áƒáƒ¬áƒ”áƒ áƒ” áƒ‘áƒáƒœáƒ£áƒ¡ áƒ—áƒáƒ•áƒ¡áƒáƒ¢áƒ”áƒ®áƒ”áƒ‘áƒ˜áƒ¡ PDF áƒ¤áƒáƒ˜áƒšáƒ˜
        </p>
        <button class="btn btn-download" onclick="downloadPDF()">
          ğŸ“¥ áƒ’áƒáƒ“áƒ›áƒáƒ¬áƒ”áƒ áƒ (PDF)
        </button>
      </div>
    </div>

    <div class="footer">
      áƒ”áƒ¡ áƒ¡áƒáƒ˜áƒ¢áƒ˜ áƒáƒ  áƒáƒ’áƒ áƒáƒ•áƒ”áƒ‘áƒ¡ áƒáƒ”áƒ áƒ¡áƒáƒœáƒáƒšáƒ£áƒ  áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ¡.<br>
      Â© 2026 Kandelucky
    </div>
  </div>

  <script>
    /* =========================================
     *  SOUND MANAGER â€” Web Audio API
     * ========================================= */
    class SoundManager {
      constructor() {
        this.enabled = true;
        this.ctx = null;
      }

      init() {
        if (!this.ctx) {
          this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (this.ctx.state === 'suspended') this.ctx.resume();
      }

      toggle() {
        this.enabled = !this.enabled;
        document.getElementById('soundToggle').textContent = this.enabled ? 'ğŸ”Š' : 'ğŸ”‡';
      }

      _tone(freq, duration, type = 'sine', volume = 0.3) {
        if (!this.enabled || !this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(volume, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
      }

      click() { this._tone(800, 0.08, 'sine', 0.2); }

      correct() {
        this._tone(523, 0.12, 'sine', 0.25);
        setTimeout(() => this._tone(659, 0.15, 'sine', 0.25), 100);
      }

      wrong() { this._tone(200, 0.25, 'sawtooth', 0.15); }

      unlock() {
        [523, 659, 784, 1047].forEach((f, i) => {
          setTimeout(() => this._tone(f, 0.2, 'sine', 0.2), i * 120);
        });
      }

      victory() {
        const notes = [523, 523, 587, 659, 659, 587, 523, 494, 440, 440, 494, 523, 523, 494, 494];
        notes.forEach((f, i) => {
          setTimeout(() => this._tone(f, 0.18, 'sine', 0.2), i * 140);
        });
      }
    }

    const sound = new SoundManager();
    document.getElementById('soundToggle').addEventListener('click', () => {
      sound.init();
      sound.toggle();
      sound.click();
    });

    /* =========================================
     *  FULLSCREEN
     * ========================================= */
    const fsBtn = document.getElementById('fullscreenToggle');

    function isFullscreen() {
      return !!(document.fullscreenElement || document.webkitFullscreenElement);
    }

    function syncFsButton() {
      if (isFullscreen()) {
        fsBtn.textContent = 'âœ•';
        fsBtn.title = 'áƒ¡áƒ áƒ£áƒšáƒ˜ áƒ”áƒ™áƒ áƒáƒœáƒ˜áƒ“áƒáƒœ áƒ’áƒáƒ›áƒáƒ¡áƒ•áƒšáƒ';
      } else {
        fsBtn.textContent = 'â›¶';
        fsBtn.title = 'áƒ¡áƒ áƒ£áƒš áƒ”áƒ™áƒ áƒáƒœáƒ–áƒ”';
      }
    }

    fsBtn.addEventListener('click', () => {
      sound.init();
      sound.click();
      if (!isFullscreen()) {
        const el = document.documentElement;
        const rfs = el.requestFullscreen || el.webkitRequestFullscreen;
        if (rfs) rfs.call(el).catch(() => {});
      } else {
        userWantsFullscreen = false; // User intentionally exiting
        const efs = document.exitFullscreen || document.webkitExitFullscreen;
        if (efs) efs.call(document);
      }
    });

    // Track whether user has opted into fullscreen
    let userWantsFullscreen = false;

    // Sync button on any fullscreen change (including browser-forced exit)
    ['fullscreenchange', 'webkitfullscreenchange'].forEach(evt => {
      document.addEventListener(evt, () => {
        syncFsButton();
        if (isFullscreen()) {
          userWantsFullscreen = true;
          removeRestoreOverlay();
        } else if (userWantsFullscreen) {
          // Fullscreen was lost unexpectedly â€” show restore overlay
          setTimeout(() => {
            if (!isFullscreen() && userWantsFullscreen) {
              showRestoreOverlay();
            }
          }, 400);
        }
      });
    });

    // Chrome mobile: download dialogs & tab switches break fullscreen
    document.addEventListener('visibilitychange', () => {
      setTimeout(syncFsButton, 300);
    });
    window.addEventListener('resize', () => {
      setTimeout(syncFsButton, 100);
    });

    /* -- Fullscreen restore overlay -- */
    function showRestoreOverlay() {
      if (document.getElementById('fsRestoreOverlay')) return;
      const ov = document.createElement('div');
      ov.id = 'fsRestoreOverlay';
      ov.style.cssText = `
        position:fixed;inset:0;z-index:99999;
        background:rgba(0,0,0,0.82);
        display:flex;flex-direction:column;
        align-items:center;justify-content:center;
        cursor:pointer;user-select:none;
        -webkit-tap-highlight-color:transparent;
      `;
      ov.innerHTML = `
        <div style="font-size:56px;margin-bottom:16px;">â›¶</div>
        <div style="color:#fff;font-family:'Fredoka',sans-serif;font-size:18px;font-weight:600;">
          áƒ¨áƒ”áƒ”áƒ®áƒ” áƒ¡áƒ áƒ£áƒš áƒ”áƒ™áƒ áƒáƒœáƒ–áƒ” áƒ“áƒáƒ¡áƒáƒ‘áƒ áƒ£áƒœáƒ”áƒ‘áƒšáƒáƒ“
        </div>
      `;
      ov.addEventListener('click', () => {
        const el = document.documentElement;
        const rfs = el.requestFullscreen || el.webkitRequestFullscreen;
        if (rfs) rfs.call(el).catch(() => {});
        removeRestoreOverlay();
      });
      document.body.appendChild(ov);
    }

    function removeRestoreOverlay() {
      const ov = document.getElementById('fsRestoreOverlay');
      if (ov) ov.remove();
    }

    /* =========================================
     *  BUTTON RIPPLE EFFECT
     * ========================================= */
    document.querySelectorAll('.btn').forEach(btn => {
      btn.addEventListener('mousemove', (e) => {
        const rect = btn.getBoundingClientRect();
        btn.style.setProperty('--x', ((e.clientX - rect.left) / rect.width * 100) + '%');
        btn.style.setProperty('--y', ((e.clientY - rect.top) / rect.height * 100) + '%');
      });
    });

    /* =========================================
     *  ENCRYPTION & PASSWORD
     * ========================================= */
    const DEMO_PASSWORD = "TEST2024";

    const puzzleConfig = {
      message: "SUPER STAR",
      hints: ['S', 'A', 'R'],
      victoryText: "SUPER STAR"
    };

    const encryptedPuzzle = CryptoJS.AES.encrypt(
      JSON.stringify(puzzleConfig), DEMO_PASSWORD
    ).toString();

    const pdfMessage = "áƒ”áƒ¡ áƒáƒ áƒ˜áƒ¡ áƒ‘áƒáƒœáƒ£áƒ¡ PDF-áƒ˜áƒ¡ áƒ¡áƒáƒ¢áƒ”áƒ¡áƒ¢áƒ áƒ•áƒ”áƒ áƒ¡áƒ˜áƒ. áƒ áƒ”áƒáƒšáƒ£áƒ  áƒáƒ áƒáƒ“áƒ£áƒ¥áƒ¢áƒ¨áƒ˜ áƒáƒ¥ áƒ˜áƒ¥áƒœáƒ”áƒ‘áƒ áƒ—áƒáƒ•áƒ¡áƒáƒ¢áƒ”áƒ®áƒ”áƒ‘áƒ˜áƒ¡ áƒ¤áƒáƒ˜áƒšáƒ˜.";
    const encryptedPDF = CryptoJS.AES.encrypt(pdfMessage, DEMO_PASSWORD).toString();

    let decryptedPuzzle = null;

    function tryUnlock() {
      sound.init();
      sound.click();

      const password = document.getElementById('passwordInput').value.trim();
      const errorEl = document.getElementById('passwordError');

      try {
        const bytes = CryptoJS.AES.decrypt(encryptedPuzzle, password);
        const text = bytes.toString(CryptoJS.enc.Utf8);
        if (!text) throw new Error('wrong');

        decryptedPuzzle = JSON.parse(text);
        errorEl.classList.remove('show');

        sound.unlock();
        document.getElementById('passwordSection').style.display = 'none';
        document.getElementById('puzzleSection').classList.add('visible');
        initPuzzle(decryptedPuzzle);

      } catch (e) {
        sound.wrong();
        errorEl.classList.add('show');
        document.getElementById('passwordInput').value = '';
        document.getElementById('passwordInput').focus();
      }
    }

    document.getElementById('passwordInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') tryUnlock();
    });

    /* =========================================
     *  CIPHER PUZZLE â€” with custom font
     * ========================================= */
    function initPuzzle(config) {
      const message = config.message.toUpperCase();
      const hints = new Set(config.hints.map(h => h.toUpperCase()));
      const grid = document.getElementById('cipherGrid');
      const keyDiv = document.getElementById('cipherKey');

      // Keep the title, clear the rest
      keyDiv.innerHTML = '<div class="cipher-key-title">áƒ¨áƒ˜áƒ¤áƒ áƒ˜áƒ¡ áƒ’áƒáƒ¡áƒáƒ¦áƒ”áƒ‘áƒ˜</div>';
      grid.innerHTML = '';

      // Build cipher key â€” symbol (in cipher font) = letter
      const usedLetters = new Set(message.replace(/ /g, '').split(''));
      const allLetters = [...usedLetters].sort();

      allLetters.forEach(letter => {
        const item = document.createElement('div');
        item.className = hints.has(letter) ? 'key-item' : 'key-item unknown';
        item.dataset.letter = letter;

        const symbolSpan = document.createElement('span');
        symbolSpan.className = 'key-symbol';
        symbolSpan.textContent = letter; // Displayed in CipherFont

        const equalsSpan = document.createTextNode(' = ');

        const letterSpan = document.createElement('span');
        letterSpan.className = 'key-letter';
        letterSpan.textContent = hints.has(letter) ? letter : '?';

        item.appendChild(symbolSpan);
        item.appendChild(equalsSpan);
        item.appendChild(letterSpan);
        keyDiv.appendChild(item);
      });

      // Build puzzle grid
      let inputIndex = 0;
      let totalInputs = 0;
      let solvedInputs = 0;

      message.split('').forEach((char) => {
        if (char === ' ') {
          const space = document.createElement('div');
          space.className = 'cipher-space';
          grid.appendChild(space);
          return;
        }

        const cell = document.createElement('div');
        cell.className = 'cipher-cell';

        // Symbol box â€” letter displayed in cipher font
        const code = document.createElement('div');
        code.className = 'cipher-code';
        code.textContent = char; // CipherFont renders this as a symbol

        // Input box â€” child types the real letter
        const input = document.createElement('input');
        input.type = 'text';
        input.maxLength = 1;
        input.className = 'cipher-input';
        input.dataset.answer = char;
        input.dataset.index = inputIndex++;

        if (hints.has(char)) {
          input.value = char;
          input.classList.add('hint');
          input.readOnly = true;
          solvedInputs++;
        }

        totalInputs++;
        cell.appendChild(code);
        cell.appendChild(input);
        grid.appendChild(cell);
      });

      document.getElementById('totalCount').textContent = totalInputs;
      document.getElementById('solvedCount').textContent = solvedInputs;
      document.getElementById('hintCount').textContent = hints.size;

      // Input handlers
      const inputs = grid.querySelectorAll('.cipher-input:not([readonly])');

      inputs.forEach(inp => {
        inp.addEventListener('input', (e) => {
          sound.init();
          const val = e.target.value.toUpperCase();
          e.target.value = val;
          if (val === '') return;

          if (val === e.target.dataset.answer) {
            // Correct
            e.target.classList.remove('wrong');
            e.target.classList.add('correct');
            e.target.readOnly = true;
            sound.correct();

            // Auto-fill same letters
            grid.querySelectorAll('.cipher-input').forEach(other => {
              if (other.dataset.answer === val && !other.readOnly) {
                other.value = val;
                other.classList.add('correct');
                other.readOnly = true;
              }
            });

            // Update key display
            updateKeyDisplay(val);
            updateStatus();
            checkVictory(config);

            // Focus next empty
            const nextEmpty = grid.querySelector('.cipher-input:not([readonly])');
            if (nextEmpty) nextEmpty.focus();

          } else {
            // Wrong
            e.target.classList.remove('correct');
            e.target.classList.add('wrong');
            sound.wrong();
            setTimeout(() => {
              e.target.classList.remove('wrong');
              e.target.value = '';
              e.target.focus();
            }, 500);
          }
        });

        inp.addEventListener('focus', () => sound.init());
      });

      // Focus first empty input
      const firstEmpty = grid.querySelector('.cipher-input:not([readonly])');
      if (firstEmpty) firstEmpty.focus();
    }

    function updateKeyDisplay(letter) {
      document.querySelectorAll('.key-item').forEach(item => {
        if (item.dataset.letter === letter) {
          item.classList.remove('unknown');
          item.querySelector('.key-letter').textContent = letter;
        }
      });
    }

    function updateStatus() {
      const solved = document.querySelectorAll('.cipher-input[readonly]').length;
      document.getElementById('solvedCount').textContent = solved;
    }

    function checkVictory(config) {
      const allInputs = document.querySelectorAll('.cipher-input');
      const allSolved = [...allInputs].every(inp => inp.readOnly);

      if (allSolved) {
        setTimeout(() => {
          document.getElementById('decodedMessage').textContent = config.victoryText;
          sound.victory();
          showVictory();
          startConfetti();
        }, 400);
      }
    }

    /* =========================================
     *  VICTORY & CONFETTI
     * ========================================= */
    function showVictory() {
      document.getElementById('victoryOverlay').classList.add('show');
    }

    function closeVictory() {
      sound.click();
      document.getElementById('victoryOverlay').classList.remove('show');
      document.getElementById('pdfSection').classList.add('visible');
      document.getElementById('pdfSection').scrollIntoView({ behavior: 'smooth' });
    }

    function startConfetti() {
      const canvas = document.getElementById('confetti-canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const colors = ['#6c5ce7', '#fd79a8', '#00b894', '#fdcb6e', '#e17055', '#0984e3', '#00cec9'];
      const particles = [];

      for (let i = 0; i < 120; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: -20 - Math.random() * 200,
          w: 6 + Math.random() * 8,
          h: 4 + Math.random() * 6,
          color: colors[Math.floor(Math.random() * colors.length)],
          vx: (Math.random() - 0.5) * 4,
          vy: 2 + Math.random() * 4,
          rotation: Math.random() * 360,
          rotSpeed: (Math.random() - 0.5) * 10,
          opacity: 1
        });
      }

      let frame = 0;
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.05;
          p.rotation += p.rotSpeed;
          if (frame > 100) p.opacity -= 0.01;
          if (p.opacity <= 0) return;
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rotation * Math.PI / 180);
          ctx.globalAlpha = Math.max(0, p.opacity);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
          ctx.restore();
        });
        frame++;
        if (frame < 250 && particles.some(p => p.opacity > 0)) {
          requestAnimationFrame(animate);
        } else {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }
      animate();
    }

    /* =========================================
     *  PDF DOWNLOAD
     *  â€” unique filename each time to prevent
     *    Chrome's "Download again?" dialog
     * ========================================= */
    function downloadPDF() {
      sound.init();
      sound.click();

      const password = document.getElementById('passwordInput')?.value || DEMO_PASSWORD;
      try {
        const bytes = CryptoJS.AES.decrypt(encryptedPDF, password);
        const text = bytes.toString(CryptoJS.enc.Utf8);
        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        // Unique filename prevents Chrome duplicate-download dialog
        a.download = 'bonus-puzzle_' + Date.now() + '.txt';
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 5000);
      } catch (e) {
        console.error('Download failed');
      }
    }

    /* =========================================
     *  WINDOW RESIZE
     * ========================================= */
    window.addEventListener('resize', () => {
      const canvas = document.getElementById('confetti-canvas');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });

    /* =========================================
     *  CONSOLE INFO
     * ========================================= */
    console.log('%cğŸ§© áƒ‘áƒáƒœáƒ£áƒ¡ áƒ—áƒáƒ•áƒ¡áƒáƒ¢áƒ”áƒ®áƒ˜ â€” áƒ¡áƒáƒ¢áƒ”áƒ¡áƒ¢áƒ áƒ•áƒ”áƒ áƒ¡áƒ˜áƒ', 'font-size: 16px; font-weight: bold;');
    console.log('%cáƒ¡áƒáƒ¢áƒ”áƒ¡áƒ¢áƒ áƒáƒáƒ áƒáƒšáƒ˜: TEST2024', 'color: #6c5ce7; font-size: 14px;');
  </script>

</body>
</html>
